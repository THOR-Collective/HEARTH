# H013
Unauthorized Execution of PowerShell Scripts

| Hunt # | Idea / Hypothesis                                                                 | Tactic           | Notes                                   | Tags                                   | Submitter   | 
|--------------|----------------------------------------------------------------------------|------------------|-----------------------------------------|----------------------------------------|----------------------------------------|
| H013        | Attackers often utilize PowerShell, a powerful scripting language available on Windows systems, to execute malicious commands, download additional payloads, or manipulate system configurations. Detecting the execution of unauthorized or suspicious PowerShell scripts is crucial, as it may indicate the presence of an adversary attempting to compromise the system. Native windows Event ID 4104 is crucial to detect suspicious script executions. | Execution | Below are key implementation notes to guide this process: <br></br>1. Sysmon Configuration<br></br>Event ID 1 (Process Creation): Configure Sysmon to capture detailed information about process creations, focusing on powershell.exe executions. Ensure that command-line arguments are logged to detect potentially malicious scripts or commands.<br></br>Event ID 4104 (PowerShell Script Block Logging): While Sysmon does not natively capture PowerShell script block logging, enabling this feature in PowerShell settings can provide visibility into the content of executed scripts. This requires configuring PowerShell to log detailed script blocks to the Windows Event Log.<br></br>2. Detection Logic and Filtering<br></br>Baseline Normal Activity: Establish a baseline of normal PowerShell usage within the environment to differentiate between legitimate administrative activities and potential malicious behavior.<br></br>Anomaly Detection: Develop detection rules to identify anomalies, such as unusual command-line arguments, execution times, or user contexts that deviate from the established baseline.<br></br>Filtering Noise: Apply filters to exclude known legitimate PowerShell activities to reduce false positives and focus on suspicious events.<br></br>Limitations and Assumptions<br></br>Encrypted or Obfuscated Scripts: Attackers may use obfuscation or encryption to evade detection. Regularly update detection mechanisms to recognize and alert on such techniques. | #Powershell #Sysmon #Execution #TA0002 #T1059.001      | [Siddhant Mishra](https://www.linkedin.com/in/siddhant-mishra-b190b630/) |

## Why

- Detecting unauthorized PowerShell script execution using Sysmon significantly enhances an organization's security posture by providing detailed visibility into potentially malicious activities
- Sysmon's comprehensive logging capabilities enable the identification of suspicious PowerShell commands, such as the use of DownloadFile methods to retrieve malicious payloads or obfuscated scripts designed to evade detection
- By monitoring these activities, security teams can promptly detect and respond to threats, preventing unauthorized code execution, data exfiltration, or further system compromise. Implementing such monitoring is crucial for maintaining system integrity and safeguarding against sophisticated attack vectors that leverage PowerShell's extensive functionalities.

## References

- https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon
- https://techcommunity.microsoft.com/blog/microsoftsentinelblog/the-power-of-data-collection-rules-monitoring-powershell-usage/4236527
- https://www.blumira.com/blog/sysmon-benefits
